import{_ as s,c as n,o as a,a as l}from"./app.84b65922.js";const m=JSON.parse('{"title":"使用 Pipeline 自动构建并部署","description":"","frontmatter":{},"headers":[{"level":3,"title":"配置文件参考","slug":"配置文件参考","link":"#配置文件参考","children":[]}],"relativePath":"deploy/gitee-pipeline.md","lastUpdated":1673507700000}'),p={name:"deploy/gitee-pipeline.md"},e=l(`<h1 id="使用-pipeline-自动构建并部署" tabindex="-1">使用 Pipeline 自动构建并部署 <a class="header-anchor" href="#使用-pipeline-自动构建并部署" aria-hidden="true">#</a></h1><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>以 Gitee 为例</p></div><nav class="table-of-contents"><ul><li><a href="#配置文件参考">配置文件参考</a></li></ul></nav><h3 id="配置文件参考" tabindex="-1">配置文件参考 <a class="header-anchor" href="#配置文件参考" aria-hidden="true">#</a></h3><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki"><code><span class="line"><span style="color:#8BE9FD;">version</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">1.0</span><span style="color:#E9F284;">&#39;</span></span>
<span class="line"><span style="color:#8BE9FD;">name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">pipeline-deploy-to-test</span></span>
<span class="line"><span style="color:#8BE9FD;">displayName</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">Deploy-Test</span></span>
<span class="line"><span style="color:#8BE9FD;">triggers</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#8BE9FD;">trigger</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">auto</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#8BE9FD;">push</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">branches</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">precise</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">master</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">commitMessages</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">include</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">deploy.*</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">.*?</span></span>
<span class="line"><span style="color:#8BE9FD;">variables</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#8BE9FD;">REPO_NAME</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">repo-name</span></span>
<span class="line"><span style="color:#8BE9FD;">stages</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;">name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">stage-87421f63</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">displayName</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">构建</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">strategy</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">naturally</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">trigger</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">auto</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">executor</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">linnzh</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">steps</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#6272A4;">#     根据项目下 Dockerfile 构建 docker 镜像</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;">step</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">build@docker</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">build_docker</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">displayName</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">镜像构建</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span></span>
<span class="line"><span style="color:#6272A4;">#        请务必保证 repository 下存在一个与 gitee 个人空间地址 相同的命名空间</span></span>
<span class="line"><span style="color:#6272A4;">#        因为 Gitee Go 的镜像构建存在问题，无法指定命名空间，会将Gitee 的个人空间地址作为阿里云的命名空间使用</span></span>
<span class="line"><span style="color:#6272A4;">#        参考：https://juejin.cn/post/7130895772664463368</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">type</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">account</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">repository</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">registry.cn-hangzhou.aliyuncs.com</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">username</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">183****6666</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">password</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">*</span><span style="color:#50FA7B;font-weight:bold;">********</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">tag</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">\${GITEE_REPO}:\${GITEE_BRANCH}</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">dockerfile</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">./Dockerfile</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">context</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">artifacts</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> []</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span></span>
<span class="line"><span style="color:#6272A4;">#       开启 Docker 缓存之后会导致 Gitee Go 没有权限写入缓存</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">isCache</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#BD93F9;">false</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span></span>
<span class="line"><span style="color:#6272A4;">#       Docker 镜像的 --build-args 参数</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">parameter</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#8BE9FD;">timezone</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">Asia/Shanghai</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">notify</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> []</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">strategy</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#8BE9FD;">retry</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">0</span><span style="color:#E9F284;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">#       部署至服务器</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#8BE9FD;">step</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">shell@agent</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">execute_shell</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">displayName</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">Shell 脚本执行</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#6272A4;"># 主机组信息</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">hostGroupID</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#8BE9FD;">ID</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">Server-ID</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#8BE9FD;">hostID</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">            </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">xxxxxxxxxxxxxx</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">script</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">echo &#39;Hello \${GITEE_REPO}!&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">docker rm \${REPO_NAME} -f</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">docker run -itd --name=\${REPO_NAME} -p=9511:9501 -v=/codes/\${REPO_NAME}/.env:/opt/www/.env --network=docker_network_default \${GITEE_DOCKER_IMAGE}</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">strategy</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">          </span><span style="color:#8BE9FD;">retry</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">0</span><span style="color:#E9F284;">&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">        </span><span style="color:#8BE9FD;">dependsOn</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">build_docker</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div>`,5),o=[e];function F(r,c,t,y,i,b){return a(),n("div",null,o)}const C=s(p,[["render",F]]);export{m as __pageData,C as default};
