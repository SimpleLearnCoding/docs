import{_ as s,c as n,o as e,a}from"./app.62ccd090.js";const y=JSON.parse('{"title":"Vite Press build error","description":"","frontmatter":{},"headers":[{"level":2,"title":"前情","slug":"前情","link":"#前情","children":[]},{"level":2,"title":"本地排查","slug":"本地排查","link":"#本地排查","children":[{"level":3,"title":"未安装依赖？","slug":"未安装依赖","link":"#未安装依赖","children":[]}]},{"level":2,"title":"容器排查","slug":"容器排查","link":"#容器排查","children":[{"level":3,"title":"Node Alpine 镜像问题","slug":"node-alpine-镜像问题","link":"#node-alpine-镜像问题","children":[]},{"level":3,"title":"其他问题","slug":"其他问题","link":"#其他问题","children":[]}]},{"level":2,"title":"更多的坑","slug":"更多的坑","link":"#更多的坑","children":[{"level":3,"title":"Cannot find module","slug":"cannot-find-module","link":"#cannot-find-module","children":[]},{"level":3,"title":"License should be a valid SPDX license expression","slug":"license-should-be-a-valid-spdx-license-expression","link":"#license-should-be-a-valid-spdx-license-expression","children":[]}]},{"level":2,"title":"写在最后","slug":"写在最后","link":"#写在最后","children":[]}],"relativePath":"problem-and-solution/vitepress-build-error.md","lastUpdated":1675064156000}'),l={name:"problem-and-solution/vitepress-build-error.md"},p=a(`<h1 id="vite-press-build-error" tabindex="-1">Vite Press build error <a class="header-anchor" href="#vite-press-build-error" aria-hidden="true">#</a></h1><blockquote><p>记一次使用 GitHub Action 构建 Vite Press 项目时遇到的错误。</p></blockquote><h2 id="前情" tabindex="-1">前情 <a class="header-anchor" href="#前情" aria-hidden="true">#</a></h2><p>笔者使用 Vite Press 搭建了一个个人博客，配合 GitHub Action 的自动部署。前几天还在正常运行，在昨天突然发现构建失败了，进入 Actions 查看构建过程发现以下报错：</p><div class="language-bash line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;">Run yarn docs:build</span></span>
<span class="line"><span style="color:#6272A4;">##[debug]/usr/bin/bash -e /home/runner/work/_temp/bcd14533-9b56-4c8f-8151-9c8931e25bd4.sh</span></span>
<span class="line"><span style="color:#F8F8F2;">yarn run v1.22.19</span></span>
<span class="line"><span style="color:#F8F8F2;">warning package.json: License should be a valid SPDX license expression</span></span>
<span class="line"><span style="color:#F8F8F2;">$ vitepress build config</span></span>
<span class="line"><span style="color:#F8F8F2;">vitepress v1.0.0-alpha.43</span></span>
<span class="line"><span style="color:#F8F8F2;">- building client + server bundles...</span></span>
<span class="line"><span style="color:#F8F8F2;">✖ building client + server bundles...</span></span>
<span class="line"><span style="color:#F8F8F2;">build error:</span></span>
<span class="line"><span style="color:#F8F8F2;"> [Error: ENOENT: no such file or directory, open </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">/home/runner/work/simplelearncoding.github.io/simplelearncoding.github.io/node_modules/shiki/themes/material-palenight.json</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">] {</span></span>
<span class="line"><span style="color:#F8F8F2;">  errno: -2,</span></span>
<span class="line"><span style="color:#F8F8F2;">  code: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">ENOENT</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  syscall: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">open</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  path: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">/home/runner/work/simplelearncoding.github.io/simplelearncoding.github.io/node_modules/shiki/themes/material-palenight.json</span><span style="color:#E9F284;">&#39;</span></span>
<span class="line"><span style="color:#F8F8F2;">}</span></span>
<span class="line"><span style="color:#F8F8F2;">error Command failed with </span><span style="color:#8BE9FD;">exit</span><span style="color:#F8F8F2;"> code 1.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>其关键报错信息：<code>ENOENT: no such file or directory, open &#39;/home/runner/work/simplelearncoding.github.io/simplelearncoding.github.io/node_modules/shiki/themes/material-palenight.json&#39;]</code>提示文件不存在。</p><h2 id="本地排查" tabindex="-1">本地排查 <a class="header-anchor" href="#本地排查" aria-hidden="true">#</a></h2><p>为此笔者立刻查看了自己本地项目<code>node_modules</code>目录下是否存在该文件，结果是存在的。</p><blockquote><p>在写本文时，笔者突然就发现了这个错误最根本的地方在于 vitepress v1.0.0-alpha.43 版本与<code>package.json</code>中定义的并不一致。</p><p>但由于对前端包版本控制系统的不了解，以及对著名项目的信任，无法往「版本兼容性」方向想——毕竟，谁会想到只是小版本的更新也会导致问题呢？</p></blockquote><h3 id="未安装依赖" tabindex="-1">未安装依赖？ <a class="header-anchor" href="#未安装依赖" aria-hidden="true">#</a></h3><p>随后想到可能是 GitHub Action 安装依赖不完整，于是将<code>.github/workflows/deploy.yml</code>流水线部署文件中关于<code>yarn install</code>的部分，改为了<code>yarn install --no-lockfile</code>。</p><p>此时并没有 push 至 GitHub 进行测试，而是删除了本地项目的<code>node_modules</code>目录，并运行命令<code>yarn install --no-lockfile</code>。结果连<code>yarn docs:dev</code>命令也无法运行，报错信息同上。</p><p>在这个过程中，还遇到了一些问题。</p><h2 id="容器排查" tabindex="-1">容器排查 <a class="header-anchor" href="#容器排查" aria-hidden="true">#</a></h2><p>在本地始终无法复现该问题时，我想起前段时间运行公司前端项目一直失败的事情，前端同学认为我的「Node 版本过高」。</p><p>使用<code>node -v</code>检查了一下，发现是 19.x 版本，而对方使用的是 16.x。遂琢磨着使用<strong>Docker容器</strong>来构建项目。</p><h3 id="node-alpine-镜像问题" tabindex="-1">Node Alpine 镜像问题 <a class="header-anchor" href="#node-alpine-镜像问题" aria-hidden="true">#</a></h3><p>在 Docker 的使用方面，我一直倾向于使用<strong>Alpine</strong>版本。在执行<code>yarn docs:dev</code>时没有报错，而后执行<code>yarn docs:build</code>时，引发错误：</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;">/opt/www </span><span style="color:#6272A4;"># yarn docs:build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">$ vitepress build config</span></span>
<span class="line"><span style="color:#F8F8F2;">vitepress v1.0.0-alpha.43</span></span>
<span class="line"><span style="color:#F8F8F2;">⠦ building client + server bundles...[vitepress] spawn git ENOENT</span></span>
<span class="line"><span style="color:#F8F8F2;">file: /opt/www/docs/db/redis-basic.md</span></span>
<span class="line"><span style="color:#F8F8F2;">✖ building client + server bundles...</span></span>
<span class="line"><span style="color:#F8F8F2;">build error:</span></span>
<span class="line"><span style="color:#F8F8F2;"> Error: spawn git ENOENT</span></span>
<span class="line"><span style="color:#F8F8F2;">    at Process.ChildProcess._handle.onexit (node:internal/child_process:285:19)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at onErrorNT (node:internal/child_process:485:16)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at processTicksAndRejections (node:internal/process/task_queues:83:21) {</span></span>
<span class="line"><span style="color:#F8F8F2;">  errno: -2,</span></span>
<span class="line"><span style="color:#F8F8F2;">  code: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">PLUGIN_ERROR</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  syscall: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">spawn git</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  path: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">git</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  spawnargs: [ </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">log</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">-1</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">--pretty=&quot;%ci&quot;</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">, </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">/opt/www/docs/db/redis-basic.md</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;"> ],</span></span>
<span class="line"><span style="color:#F8F8F2;">  pluginCode: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">ENOENT</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  plugin: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">vitepress</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  hook: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">transform</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">  id: </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">/opt/www/docs/db/redis-basic.md</span><span style="color:#E9F284;">&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>很轻易地，我的注意力被其所提示的文件吸引，猜测<strong>可能是文件的格式语法不支持</strong>（因为之前出现过因为 markdown 代码块语法不支持某个语言的报错）。</p><p>花时间去检查 markdown 语法后，重新执行 build 命令，报错信息还是如此。</p><p>意识到方向出了问题，遂 Google，得知是<strong>缺少<code>git</code></strong>。</p><p>我当时无法置信，为何一个前端项目构建过程会用到 git 版本控制？但事实上它就是需要。我没去刨根问底，只是默默<code>apt add git</code>了一下。</p><h3 id="其他问题" tabindex="-1">其他问题 <a class="header-anchor" href="#其他问题" aria-hidden="true">#</a></h3><p>安装 git 后，执行 build 命令，它告诉我渲染页面时出现了问题：</p><div class="language-shell line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;">✖ rendering pages...</span></span>
<span class="line"><span style="color:#F8F8F2;">build error:</span></span>
<span class="line"><span style="color:#F8F8F2;"> TypeError: Cannot </span><span style="color:#8BE9FD;">read</span><span style="color:#F8F8F2;"> properties of undefined (reading </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replace</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at normalizeLink</span><span style="color:#BD93F9;">$1</span><span style="color:#F8F8F2;"> (file:///opt/www/config/.vitepress/.temp/app.js:398:91)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at file:///opt/www/config/.vitepress/.temp/app.js:3241:92</span></span>
<span class="line"><span style="color:#F8F8F2;">    at renderComponentSubTree (/opt/www/node_modules/@vue/server-renderer/dist/server-renderer.cjs.prod.js:251:17)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at renderComponentVNode (/opt/www/node_modules/@vue/server-renderer/dist/server-renderer.cjs.prod.js:185:16)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at ssrRenderComponent (/opt/www/node_modules/@vue/server-renderer/dist/server-renderer.cjs.prod.js:621:12)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at file:///opt/www/config/.vitepress/.temp/app.js:3358:13</span></span>
<span class="line"><span style="color:#F8F8F2;">    at renderComponentSubTree (/opt/www/node_modules/@vue/server-renderer/dist/server-renderer.cjs.prod.js:251:17)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at renderComponentVNode (/opt/www/node_modules/@vue/server-renderer/dist/server-renderer.cjs.prod.js:185:16)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at ssrRenderComponent (/opt/www/node_modules/@vue/server-renderer/dist/server-renderer.cjs.prod.js:621:12)</span></span>
<span class="line"><span style="color:#F8F8F2;">    at file:///opt/www/config/.vitepress/.temp/app.js:3442:15</span></span>
<span class="line"><span style="color:#F8F8F2;">error Command failed with </span><span style="color:#8BE9FD;">exit</span><span style="color:#F8F8F2;"> code 1.</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>并且还在<code>.vitepress</code>目录下生成了<code>.temp</code>的缓存目录。</p><p>我只得删除所有依赖和缓存文件，再次执行安装依赖命令<code>yarn install --no-lockfile</code>。</p><p>安装完毕后 webstorm 提示我配置文件<code>config/.vitepress/config.ts</code>存在致命错误：</p><p><code>cleanUrls</code>选项只能是 Boolean 类型，而我写的是<code>cleanUrls: &#39;with-subfolders&#39;</code>。</p><p>查看其声明，webstorm 提示的确实没错。于是去翻 vite press 的官方说明，也确实如此。</p><p>问题是，vite press 配置基本是我复制其官方而来。</p><p><strong>此刻我才注意到官方版本好像与项目中<code>package.json</code>中定义的并不一致</strong>（<code>1.0.0-alpha.31</code>和<code>1.0.0-alpha.43</code>）。</p><h4 id="修改版本" tabindex="-1">修改版本 <a class="header-anchor" href="#修改版本" aria-hidden="true">#</a></h4><p>无法，只能修改依赖：</p><div class="language-diff line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki"><code><span class="line"><span style="color:#FF5555;">- &quot;vitepress&quot;: &quot;^1.0.0-alpha.31&quot;,</span></span>
<span class="line"><span style="color:#50FA7B;">+ &quot;vitepress&quot;: &quot;1.0.0-alpha.31&quot;,</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>重新安装依赖并构建后，问题解决。</p><h2 id="更多的坑" tabindex="-1">更多的坑 <a class="header-anchor" href="#更多的坑" aria-hidden="true">#</a></h2><p>问题排查过程中，还遇到以下问题。</p><h3 id="cannot-find-module" tabindex="-1">Cannot find module <a class="header-anchor" href="#cannot-find-module" aria-hidden="true">#</a></h3><p>webstorm 在文件<code>config/.vitepress/theme/index.ts</code>的两条导入语句上报错：<code>Cannot find module &#39;vitepress/theme&#39; or its corresponding type declarations</code>。</p><p>该报错由<code>tsc</code>提出，项目本身是没有安装<code>tslint</code>的。</p><p>开始怀疑是<em>依赖不全</em>，但点进去文件又是存在的，遂排除；</p><p>进而猜测是 <em>IDE 本身的错误检查</em>太严格了，但一项项看过去，也没有找到符合的配置，遂排除；</p><p>最后意识到可能是 Typescript 的问题（毕竟是它提出来的）。</p><p>经过排查上面的问题后，现在至少有个<strong>环境意识</strong>了：这个 typescript 必定是 IDE 上的。</p><p>果不其然，ts 本地并未安装（<code>npm ls typescript -g</code>命令查看全局安装的 ts）。</p><p>在将 IDE 关于<strong>解释器</strong>的配置中可以看到绑定（Bundle）Typescript 版本为 4.2.2，而 Node 版本为 19.1.0。</p><p>修改 Node 16.x 版本后，该问题消失。</p><p>我不清楚 node 19.x 版本是否不兼容 4.2.2 版本的 Typescript。但为了尽量避免此类错误，我选择在<code>package.json</code>中加上<code>typescript</code>依赖，以及声明 Node 版本：</p><div class="language-diff line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">diff</span><pre class="shiki"><code><span class="line"><span style="color:#50FA7B;">+  &quot;engines&quot;: {</span></span>
<span class="line"><span style="color:#50FA7B;">+    &quot;node&quot;: &quot;&gt;=14.0.0&quot;</span></span>
<span class="line"><span style="color:#50FA7B;">+  },</span></span>
<span class="line"><span style="color:#F8F8F2;">   &quot;devDependencies&quot;: {</span></span>
<span class="line"><span style="color:#F8F8F2;">     &quot;@arco-design/web-vue&quot;: &quot;^2.40.0&quot;,</span></span>
<span class="line"><span style="color:#50FA7B;">+    &quot;typescript&quot;: &quot;^4.9.4&quot;,</span></span>
<span class="line"><span style="color:#F8F8F2;">     &quot;vitepress&quot;: &quot;1.0.0-alpha.31&quot;,</span></span>
<span class="line"><span style="color:#F8F8F2;">     &quot;vue&quot;: &quot;^3.2.45&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">   },</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><ol><li><p>经测试，node 19.x 版本是兼容 4.9.4 版本的 Typescript 的。</p></li><li><p>始终推荐「次稳定版本」的 Node，并在项目中使用 yarn 维护依赖项。</p></li></ol></div><h3 id="license-should-be-a-valid-spdx-license-expression" tabindex="-1">License should be a valid SPDX license expression <a class="header-anchor" href="#license-should-be-a-valid-spdx-license-expression" aria-hidden="true">#</a></h3><p>该错误是在安装依赖时给出的警告，好奇<code>SPDX</code>是啥，就搜索了一下，找到了<a href="https://spdx.org/licenses/" target="_blank" rel="noreferrer">SPDX License List</a>。</p><p>最后根据项目性质，设置了<a href="https://spdx.org/licenses/CC-BY-SA-4.0.html" target="_blank" rel="noreferrer"><code>CC-BY-SA-4.0</code></a>（知识共享署名相同方式共享 4.0 国际版）的许可证。</p><h2 id="写在最后" tabindex="-1">写在最后 <a class="header-anchor" href="#写在最后" aria-hidden="true">#</a></h2><p>本次体验令我对前端工具的复杂度的认知再次上了一个台阶。</p><p>不过解决问题的过程及结果还是令人兴奋不已的，会感觉自己仍然年轻、仍然可以继续学习。</p>`,58),o=[p];function r(c,i,t,d,F,u){return e(),n("div",null,o)}const h=s(l,[["render",r]]);export{y as __pageData,h as default};
