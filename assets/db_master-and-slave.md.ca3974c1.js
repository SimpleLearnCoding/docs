import{_ as s,c as n,o as a,a as l}from"./app.2b104437.js";const p="/assets/image-20230401015303127.04a876c9.png",d=JSON.parse('{"title":"MySQL - 记一次 Docker 部署主从架构","description":"","frontmatter":{},"headers":[{"level":2,"title":"概述","slug":"概述","link":"#概述","children":[]},{"level":2,"title":"MySQL","slug":"mysql","link":"#mysql","children":[{"level":3,"title":"配置","slug":"配置","link":"#配置","children":[]},{"level":3,"title":"验证","slug":"验证","link":"#验证","children":[]},{"level":3,"title":"踩坑","slug":"踩坑","link":"#踩坑","children":[]}]},{"level":2,"title":"HAProxy","slug":"haproxy","link":"#haproxy","children":[{"level":3,"title":"前置准备","slug":"前置准备","link":"#前置准备","children":[]},{"level":3,"title":"启动","slug":"启动","link":"#启动","children":[]}]}],"relativePath":"db/master-and-slave.md","lastUpdated":1680285711000}'),e={name:"db/master-and-slave.md"},o=l(`<h1 id="mysql-记一次-docker-部署主从架构" tabindex="-1">MySQL - 记一次 Docker 部署主从架构 <a class="header-anchor" href="#mysql-记一次-docker-部署主从架构" aria-hidden="true">#</a></h1><p>首先先上 Docker Compose 文件：</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki"><code><span class="line"><span style="color:#8BE9FD;">version</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">3.9</span><span style="color:#E9F284;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 定义网络</span></span>
<span class="line"><span style="color:#8BE9FD;">networks</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#8BE9FD;">default</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">driver</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">bridge</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8BE9FD;">services</span><span style="color:#FF79C6;">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#6272A4;"># 定义主数据库</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#8BE9FD;">db_master</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">image</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">mysql:8.0.31</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">container_name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">db_master</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">restart</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">always</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">networks</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">default</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">environment</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_ROOT_PASSWORD</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">linnzh</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_DATABASE</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">linnzh</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_REPLICATION_USER</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">replica</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_REPLICATION_PASSWORD</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">replica_password</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_INITDB_SKIP_TZINFO</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">yes</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">working_dir</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">/opt/www</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">expose</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#BD93F9;">3306</span></span>
<span class="line"><span style="color:#6272A4;">#    command: &quot;--server-id=1 --log-bin=binlog --binlog-do-db=linnzh --default_authentication_plugin=mysql_native_password&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">volumes</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">./conf/mysql_master.conf:/etc/mysql/conf.d/my.cnf</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">./db_master:/var/lib/mysql</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">.:/opt/www</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#6272A4;"># 定义从数据库</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#8BE9FD;">db_slave</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">image</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">mysql:8.0.31</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">container_name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">db_slave</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">restart</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">always</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">networks</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">default</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">environment</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_ROOT_PASSWORD</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">linnzh</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_DATABASE</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">linnzh</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_MASTER_HOST</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">db_master</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_MASTER_PORT</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#BD93F9;">3306</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_MASTER_USER</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">replica</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_MASTER_PASSWORD</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">replica_password</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#8BE9FD;">MYSQL_INITDB_SKIP_TZINFO</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">yes</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">working_dir</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">/opt/www</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">expose</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#BD93F9;">3306</span></span>
<span class="line"><span style="color:#6272A4;">#    command: &quot;--server-id=2 --log-bin=binlog --binlog-do-db=linnzh --skip-slave-start --default_authentication_plugin=mysql_native_password&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">volumes</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">./conf/mysql_slave.conf:/etc/mysql/conf.d/my.cnf</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">./db_slave:/var/lib/mysql</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">.:/opt/www</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#6272A4;"># 定义 HAProxy 负载均衡器</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#6272A4;"># 当客户端发起连接请求时，HAProxy会根据配置规则将请求路由到主节点或从节点上，实现负载均衡和高可用性。</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#6272A4;"># 如果主节点发生故障或不可用，HAProxy会自动将客户端请求路由到从节点上，确保服务的连续性和可用性。</span></span>
<span class="line"><span style="color:#F8F8F2;">  </span><span style="color:#8BE9FD;">haproxy</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">image</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">haproxy:lts-alpine</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">container_name</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">haproxy</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">networks</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">default</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">depends_on</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">db_master</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">db_slave</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">ports</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">3306:3306</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">1080:1080</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#8BE9FD;">volumes</span><span style="color:#FF79C6;">:</span></span>
<span class="line"><span style="color:#F8F8F2;">      </span><span style="color:#FF79C6;">-</span><span style="color:#F8F8F2;"> </span><span style="color:#F1FA8C;">./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><h2 id="概述" tabindex="-1">概述 <a class="header-anchor" href="#概述" aria-hidden="true">#</a></h2><p>以上 Docker Compose 文件配备了两个 MySQL 服务：<code>db_master</code>和<code>db_slave</code>。在 MySQL 主从架构中，master 将 write 操作的数据记录到二进制日志中，slave 数据库定期读取二进制日志并应用到自己的数据库中，还可以通过多个线程从 master 中复制数据，从而提高数据的复制速度。</p><p>MySQL 的读写分离需要一个<strong>负载均衡器</strong>（Load Balance）来分配请求到不同的数据库节点。负载均衡器可以根据应用程序的负载情况和数据库节点的负载情况来决定将请求发到哪个节点，还可以检测数据库节点的可用性，当一个节点不可用时，自动将请求发送到其他可用的节点。</p><p>MySQL 可以使用 <strong>HAProxy</strong> 来配置监听端口、转发规则、读写分离规则等。</p><h2 id="mysql" tabindex="-1">MySQL <a class="header-anchor" href="#mysql" aria-hidden="true">#</a></h2><h3 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-hidden="true">#</a></h3><ol><li><p>在主从主机上部署好 MySQL，并<strong>在主库上启用二进制日志</strong>，注意主从 server-id 必须不一样，主库的配置文件类似如下：</p><div class="language-ini line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki"><code><span class="line"><span style="color:#6272A4;"># mysql_master.conf</span></span>
<span class="line"><span style="color:#6272A4;"># master 数据库相关配置</span></span>
<span class="line"><span style="color:#F8F8F2;">[mysqld]</span></span>
<span class="line"><span style="color:#6272A4;"># required!!!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 主从 server-id 必须不一样</span></span>
<span class="line"><span style="color:#FF79C6;">server-id=</span><span style="color:#F8F8F2;">1</span></span>
<span class="line"><span style="color:#6272A4;"># 要复制的数据库，多个数据库可用英文逗号隔开</span></span>
<span class="line"><span style="color:#FF79C6;">binlog-do-db=</span><span style="color:#F8F8F2;">linnzh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># -----------------</span></span>
<span class="line"><span style="color:#6272A4;"># 剩下的是一些默认配置</span></span>
<span class="line"><span style="color:#6272A4;"># -----------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 建议主从配置一样的名字</span></span>
<span class="line"><span style="color:#FF79C6;">log-bin=</span><span style="color:#F8F8F2;">mysql-bin</span></span>
<span class="line"><span style="color:#FF79C6;">binlog-format=</span><span style="color:#F8F8F2;">row</span></span>
<span class="line"><span style="color:#FF79C6;">innodb_flush_log_at_trx_commit=</span><span style="color:#F8F8F2;">1</span></span>
<span class="line"><span style="color:#FF79C6;">sync_binlog=</span><span style="color:#F8F8F2;">1</span></span>
<span class="line"><span style="color:#6272A4;">#default_authentication_plugin=mysql_native_password</span></span>
<span class="line"><span style="color:#FF79C6;">authentication_policy=</span><span style="color:#F8F8F2;">mysql_native_password</span></span>
<span class="line"><span style="color:#FF79C6;">lower_case_table_names=</span><span style="color:#F8F8F2;">2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">host_cache_size=</span><span style="color:#F8F8F2;">0</span></span>
<span class="line"><span style="color:#FF79C6;">lower_case_table_names=</span><span style="color:#F8F8F2;">2</span></span>
<span class="line"><span style="color:#FF79C6;">performance_schema=</span><span style="color:#F8F8F2;">ON</span><span style="color:#6272A4;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;">#skip-host-cache</span></span>
<span class="line"><span style="color:#6272A4;">#skip-name-resolve</span></span>
<span class="line"><span style="color:#6272A4;">#datadir=/var/lib/mysql</span></span>
<span class="line"><span style="color:#6272A4;">#socket=/var/run/mysqld/mysqld.sock</span></span>
<span class="line"><span style="color:#6272A4;">#secure-file-priv=/var/lib/mysql-files</span></span>
<span class="line"><span style="color:#6272A4;">#user=mysql</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[mysql]</span></span>
<span class="line"><span style="color:#FF79C6;">default-character-set=</span><span style="color:#F8F8F2;">utf8mb4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[client]</span></span>
<span class="line"><span style="color:#FF79C6;">default-character-set=</span><span style="color:#F8F8F2;">utf8mb4</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div></li><li><p>从库的配置文件如下：</p><div class="language-ini line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki"><code><span class="line"><span style="color:#6272A4;"># mysql_slave.conf</span></span>
<span class="line"><span style="color:#6272A4;"># slave 数据库相关配置</span></span>
<span class="line"><span style="color:#F8F8F2;">[mysqld]</span></span>
<span class="line"><span style="color:#6272A4;"># required!!!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 主从 server-id 必须不一样</span></span>
<span class="line"><span style="color:#FF79C6;">server-id=</span><span style="color:#F8F8F2;">2</span></span>
<span class="line"><span style="color:#6272A4;"># 要复制的数据库，多个数据库可用英文逗号隔开</span></span>
<span class="line"><span style="color:#FF79C6;">binlog-do-db=</span><span style="color:#F8F8F2;">linnzh</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># -----------------</span></span>
<span class="line"><span style="color:#6272A4;"># 剩下的是一些默认配置</span></span>
<span class="line"><span style="color:#6272A4;"># -----------------</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 建议主从配置一样的名字</span></span>
<span class="line"><span style="color:#FF79C6;">log-bin=</span><span style="color:#F8F8F2;">mysql-bin</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 设置了read_only=1之后，将只有 SUPER 权限的用户才可以修改数据</span></span>
<span class="line"><span style="color:#FF79C6;">read_only</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">skip_replica_start</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FF79C6;">host_cache_size=</span><span style="color:#F8F8F2;">0</span></span>
<span class="line"><span style="color:#FF79C6;">lower_case_table_names=</span><span style="color:#F8F8F2;">2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[mysql]</span></span>
<span class="line"><span style="color:#FF79C6;">default-character-set=</span><span style="color:#F8F8F2;">utf8mb4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">[client]</span></span>
<span class="line"><span style="color:#FF79C6;">default-character-set=</span><span style="color:#F8F8F2;">utf8mb4</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div></li><li><p>在 master 数据库添加 slave 用于复制的用户并分配权限：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">. 创建用户</span></span>
<span class="line"><span style="color:#FF79C6;">CREATE</span><span style="color:#F8F8F2;"> USER </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replica</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;"> IDENTIFIED </span><span style="color:#FF79C6;">WITH</span><span style="color:#F8F8F2;"> mysql_native_password </span><span style="color:#FF79C6;">BY</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replica_password</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;"># 替换为 Docker compose 的环境变量即：</span></span>
<span class="line"><span style="color:#FF79C6;">CREATE</span><span style="color:#F8F8F2;"> USER </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_REPLICATION_USER}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;"> IDENTIFIED </span><span style="color:#FF79C6;">WITH</span><span style="color:#F8F8F2;"> mysql_native_password </span><span style="color:#FF79C6;">BY</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_REPLICATION_PASSWORD}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#BD93F9;">2</span><span style="color:#F8F8F2;">. 分配权限</span></span>
<span class="line"><span style="color:#FF79C6;">GRANT</span><span style="color:#F8F8F2;"> REPLICATION slave, REPLICATION client </span><span style="color:#FF79C6;">ON</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">*</span><span style="color:#F8F8F2;">.</span><span style="color:#FF79C6;">*</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">to</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replica</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;"># 替换为 Docker compose 的环境变量即：</span></span>
<span class="line"><span style="color:#FF79C6;">GRANT</span><span style="color:#F8F8F2;"> REPLICATION SLAVE,REPLICATION CLIENT </span><span style="color:#FF79C6;">ON</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">*</span><span style="color:#F8F8F2;">.</span><span style="color:#FF79C6;">*</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">TO</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_REPLICATION_USER}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li><li><p>slave 连接 master：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;">. slave 连接至 </span><span style="color:#FF79C6;">master</span></span>
<span class="line"><span style="color:#F8F8F2;">CHANGE </span><span style="color:#FF79C6;">MASTER</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">TO</span></span>
<span class="line"><span style="color:#F8F8F2;">    MASTER_HOST</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">127.0.0.1</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">    MASTER_PORT</span><span style="color:#FF79C6;">=</span><span style="color:#BD93F9;">3306</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">    MASTER_USER</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replica</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">,</span></span>
<span class="line"><span style="color:#F8F8F2;">    MASTER_PASSWORD</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replica_password</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;"># 替换为 Docker compose 的环境变量即：</span></span>
<span class="line"><span style="color:#F8F8F2;">CHANGE </span><span style="color:#FF79C6;">MASTER</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">TO</span><span style="color:#F8F8F2;"> MASTER_HOST</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_MASTER_HOST}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#F8F8F2;">	MASTER_PORT</span><span style="color:#FF79C6;">=</span><span style="color:#F8F8F2;">\${MYSQL_MASTER_PORT}, </span></span>
<span class="line"><span style="color:#F8F8F2;">	MASTER_USER</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_MASTER_USER}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">, </span></span>
<span class="line"><span style="color:#F8F8F2;">	MASTER_PASSWORD</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_MASTER_PASSWORD}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#BD93F9;">2</span><span style="color:#F8F8F2;">. 启动 slave（开始复制，这里直接在 </span><span style="color:#FF79C6;">start</span><span style="color:#F8F8F2;"> slave 后追加了连接用户的信息，这样就不会保存至数据库内，更加安全</span></span>
<span class="line"><span style="color:#FF79C6;">START</span><span style="color:#F8F8F2;"> SLAVE USER</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replica</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">PASSWORD=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">replica_password</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"><span style="color:#F8F8F2;"># 替换为 Docker compose 的环境变量即：</span></span>
<span class="line"><span style="color:#FF79C6;">START</span><span style="color:#F8F8F2;"> SLAVE USER</span><span style="color:#FF79C6;">=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_MASTER_USER}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">PASSWORD=</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">\${MYSQL_MASTER_PASSWORD}</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div></li><li><p>slave 停止复制：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;"># 查看连接状态：</span></span>
<span class="line"><span style="color:#F8F8F2;">SHOW SLAVE </span><span style="color:#FF79C6;">STATUS</span><span style="color:#F8F8F2;"> \\G;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># 停止复制</span></span>
<span class="line"><span style="color:#FF79C6;">STOP</span><span style="color:#F8F8F2;"> SLAVE</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol><h3 id="验证" tabindex="-1">验证 <a class="header-anchor" href="#验证" aria-hidden="true">#</a></h3><p>验证过程可以通过在 master 中创建一个表并添加数据，之后在 slave 中查看该表是否存在、该条数据是否存在。</p><p>Master 操作：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#FF79C6;">On</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># swith </span><span style="color:#FF79C6;">database</span></span>
<span class="line"><span style="color:#FF79C6;">USE</span><span style="color:#F8F8F2;"> linnzh;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#FF79C6;">create</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">table</span></span>
<span class="line"><span style="color:#FF79C6;">CREATE</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">TABLE</span><span style="color:#F8F8F2;"> test (id </span><span style="color:#FF79C6;">INT</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">PRIMARY</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">KEY</span><span style="color:#F8F8F2;"> AUTO_INCREMENT, </span><span style="color:#FF79C6;">value</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">VARCHAR</span><span style="color:#F8F8F2;">(</span><span style="color:#BD93F9;">50</span><span style="color:#F8F8F2;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#FF79C6;">insert</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">rows</span></span>
<span class="line"><span style="color:#FF79C6;">INSERT</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">INTO</span><span style="color:#F8F8F2;"> test (</span><span style="color:#FF79C6;">value</span><span style="color:#F8F8F2;">) </span><span style="color:#FF79C6;">VALUES</span><span style="color:#F8F8F2;"> (</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">value1</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">), (</span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">value2</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;">);</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Slave 操作：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#FF79C6;">On</span><span style="color:#F8F8F2;"> slave</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># swith </span><span style="color:#FF79C6;">database</span></span>
<span class="line"><span style="color:#FF79C6;">USE</span><span style="color:#F8F8F2;"> linnzh;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#FF79C6;">check</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">table</span></span>
<span class="line"><span style="color:#FF79C6;">SELECT</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">*</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">FROM</span><span style="color:#F8F8F2;"> test;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="踩坑" tabindex="-1">踩坑 <a class="header-anchor" href="#踩坑" aria-hidden="true">#</a></h3><blockquote><p>大部分坑都是因为修改 docker-compose.yml 文件后，没有及时删除数据库文件（使用了之前的缓存）导致的。</p></blockquote><ol><li><p>在配置 master 和 slave 的时候，出现过<strong>明明配置文件是不同的 server-id，但启动 slave 时报错说 server id 不允许相同</strong>。</p><p>之后忘记怎么解决的了，应该是缓存的问题。后续删掉容器映射的数据库文件后，重启，问题消失。</p><blockquote><p>或者在容器启动时加上 server-id 的配置，即：</p><div class="language-yaml line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki"><code><span class="line"><span style="color:#8BE9FD;">command</span><span style="color:#FF79C6;">:</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&quot;</span><span style="color:#F1FA8C;">--server-id=1</span><span style="color:#E9F284;">&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div></blockquote></li><li><p>出现过主从复制失败的情况，提示说 MySQL 用户<code>replica</code>已在 slave 中存在。</p><p>在 slave 删除该用户后，错误还是存在；</p><p>使用<code>stop slave;reset slave;change master...;start slave;</code>重置信息后，仍然报错；</p><p>无奈，还是删除了数据库文件，重启，问题消失。</p></li></ol><h2 id="haproxy" tabindex="-1">HAProxy <a class="header-anchor" href="#haproxy" aria-hidden="true">#</a></h2><p>负载均衡器 HAProxy 主要问题在于配置文件如何配置，参考如下：</p><div class="language-ini line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">ini</span><pre class="shiki"><code><span class="line"><span style="color:#6272A4;"># haproxy/haproxy.cfg</span></span>
<span class="line"><span style="color:#F8F8F2;">global</span></span>
<span class="line"><span style="color:#F8F8F2;">    log 127.0.0.1   local0 notice</span></span>
<span class="line"><span style="color:#F8F8F2;">    group haproxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">defaults</span></span>
<span class="line"><span style="color:#F8F8F2;">    log global</span></span>
<span class="line"><span style="color:#F8F8F2;">    mode tcp</span></span>
<span class="line"><span style="color:#F8F8F2;">    option tcplog</span></span>
<span class="line"><span style="color:#F8F8F2;">    retries 3</span></span>
<span class="line"><span style="color:#F8F8F2;">    timeout connect 5s</span></span>
<span class="line"><span style="color:#F8F8F2;">    timeout client 30s</span></span>
<span class="line"><span style="color:#F8F8F2;">    timeout server 30s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 监听 MySQL</span></span>
<span class="line"><span style="color:#F8F8F2;">listen mysql</span></span>
<span class="line"><span style="color:#F8F8F2;">	</span><span style="color:#6272A4;"># 监听 MySQL 服务的对外端口</span></span>
<span class="line"><span style="color:#F8F8F2;">    bind *:3306</span></span>
<span class="line"><span style="color:#F8F8F2;">    mode tcp</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#6272A4;"># option mysql-check 选项</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#6272A4;"># 使用名为 haproxy 的 MySQL 用户去监听 MySQL</span></span>
<span class="line"><span style="color:#F8F8F2;">    option mysql-check user haproxy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;">    balance roundrobin</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#6272A4;"># 配置监听的 MySQL 节点</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#6272A4;"># server 节点名称 节点Host:节点端口 </span></span>
<span class="line"><span style="color:#F8F8F2;">    server master db_master:3306 check</span></span>
<span class="line"><span style="color:#F8F8F2;">    server slave db_slave:3306 check</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6272A4;"># 监听统计</span></span>
<span class="line"><span style="color:#F8F8F2;">listen stats</span></span>
<span class="line"><span style="color:#F8F8F2;">	</span><span style="color:#6272A4;"># 监听页面的端口号</span></span>
<span class="line"><span style="color:#F8F8F2;">    bind *:1080</span></span>
<span class="line"><span style="color:#F8F8F2;">    mode http</span></span>
<span class="line"><span style="color:#F8F8F2;">    stats enable</span></span>
<span class="line"><span style="color:#F8F8F2;">    stats uri /stats</span></span>
<span class="line"><span style="color:#F8F8F2;">    </span><span style="color:#6272A4;"># 配置认证的登录名和密码</span></span>
<span class="line"><span style="color:#F8F8F2;">    stats auth admin:password</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>这里用到了一个<code>stats</code>页面，用来查看监听的节点信息。</p><h3 id="前置准备" tabindex="-1">前置准备 <a class="header-anchor" href="#前置准备" aria-hidden="true">#</a></h3><p>从上述配置可以看出，HAProxy 监听 MySQL 需要一个特殊的用户，这里命名为<code>haproxy</code>：</p><div class="language-sql line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki"><code><span class="line"><span style="color:#F8F8F2;"># </span><span style="color:#FF79C6;">On</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">master</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F8F8F2;"># 创建 haproxy 用户</span></span>
<span class="line"><span style="color:#FF79C6;">CREATE</span><span style="color:#F8F8F2;"> USER </span><span style="color:#E9F284;">&#39;</span><span style="color:#F1FA8C;">haproxy</span><span style="color:#E9F284;">&#39;</span><span style="color:#F8F8F2;"> IDENTIFIED </span><span style="color:#FF79C6;">WITH</span><span style="color:#F8F8F2;"> mysql_native_password </span><span style="color:#FF79C6;">BY</span><span style="color:#F8F8F2;"> </span><span style="color:#E9F284;">&#39;&#39;</span><span style="color:#F8F8F2;"> </span><span style="color:#FF79C6;">WITH</span><span style="color:#F8F8F2;"> MAX_QUERIES_PER_HOUR </span><span style="color:#BD93F9;">1</span><span style="color:#F8F8F2;"> MAX_UPDATES_PER_HOUR </span><span style="color:#BD93F9;">0</span><span style="color:#F8F8F2;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这里有一个坑：<strong>要求该用户必须是空密码</strong>。</p><p>在前面的 <code>haproxy/haproxy.cfg</code>中，配置了很多次用户名+密码的方式，都无法连接到 MySQL，后来在 StackOverflow 看到答案，必须是空密码才可以（但是在 haproxy 的官方文档没有看到相关说明）。</p><h3 id="启动" tabindex="-1">启动 <a class="header-anchor" href="#启动" aria-hidden="true">#</a></h3><p>然后启动 HAProxy 服务，访问页面<a href="http://localhost:1080/stats" target="_blank" rel="noreferrer">http://localhost:1080/stats</a>，然后输入配置的认证用户名 admin 和密码 password，就可以看到监听的 MySQL 服务：</p><p><img src="`+p+'" alt="image-20230401015303127"></p><p>具体数据含义就不深究了，启动就OK。</p>',32),r=[o];function c(F,t,i,y,b,u){return a(),n("div",null,r)}const C=s(e,[["render",c]]);export{d as __pageData,C as default};
